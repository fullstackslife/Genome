# Phase 2 Design Specification: Cell State Abstraction

**Status**: Design-only specification. No implementation.

**Phase 1 Dependency**: Phase 2 consumes only Phase 1 outputs (embeddings + metadata). It does NOT ingest raw RNA data.

---

## 1. Purpose of Phase 2

### What "Cell State" Means

A **cell state** in this platform is an abstract, inferred configuration of a biological system as represented by RNA expression patterns. It is:

- **Latent**: Not directly observable, inferred from embeddings
- **Probabilistic**: Cells may belong to multiple states with varying confidence
- **Descriptive**: Describes expression patterns, not biological meaning
- **Versioned**: State definitions evolve and are tracked over time
- **Non-diagnostic**: States have no medical or clinical interpretation

### How It Differs From Labels

**Labels** are external annotations (e.g., "tissue type", "experiment condition"). Phase 2 does NOT use labels.

**Cell states** are:
- Discovered from data (unsupervised)
- Defined by expression patterns in embedding space
- Not tied to external knowledge
- Purely data-driven abstractions

### How It Differs From Diagnoses

**Diagnoses** are medical conclusions about conditions. Phase 2 explicitly avoids:
- Any medical interpretation
- Any claim about health or disease
- Any causal inference
- Any prognostic meaning

**Cell states** are:
- Mathematical abstractions
- Pattern descriptions
- Observational summaries
- Neutral computational constructs

### How It Differs From Conditions

**Conditions** imply biological or medical states. Phase 2 uses neutral terminology:
- "State" = abstract configuration
- "Divergence" = distance from reference
- "Instability" = high variance
- "Transition" = probabilistic movement (Phase 3)

### Why It Is an Abstraction, Not a Conclusion

Cell states are:
- **Abstractions**: Simplified representations of complex expression patterns
- **Inferences**: Best-effort estimates with uncertainty
- **Descriptions**: What the data shows, not what it means
- **Observations**: Patterns in embedding space, not biological facts

They enable:
- Pattern recognition without interpretation
- Comparison without classification
- Modeling without claims
- Analysis without diagnosis

---

## 2. Inputs

### Allowed Inputs

Phase 2 consumes **only** Phase 1 outputs:

1. **Embeddings**
   - Latent embedding vectors (samples × embedding_dim)
   - Generated by Phase 1 foundation model
   - Stored as parquet files in `embeddings/{ingestion_id}/embeddings.parquet`

2. **Projection Metadata**
   - UMAP/PCA projection coordinates (if available)
   - Projection method and parameters
   - Used for visualization, not state inference

3. **Normalization Metadata**
   - Normalization parameters (log base, random seed, etc.)
   - Used for reproducibility tracking
   - Not used for state inference

4. **Model Version Info**
   - Model version identifier
   - Model architecture parameters (latent_dim, etc.)
   - Used for state versioning and compatibility

5. **Ingestion Metadata**
   - Sample IDs (non-identifying)
   - Gene count (for validation)
   - Ingestion timestamp
   - Format information (bulk vs single-cell)

### Forbidden Inputs

Phase 2 explicitly **does NOT** accept:

1. **Raw Expression Matrices**
   - Gene expression counts or normalized values
   - Phase 2 operates only on embeddings
   - Raw data is Phase 1 responsibility

2. **Clinical Labels**
   - Any external annotations (tissue type, condition, etc.)
   - Patient identifiers
   - Medical classifications
   - Experimental conditions

3. **External Annotations**
   - Gene ontology terms
   - Pathway annotations
   - Literature-derived labels
   - Any non-embedding metadata

4. **Disease Terms**
   - Any medical terminology
   - Health classifications
   - Diagnostic labels
   - Treatment information

**Rationale**: Phase 2 must remain purely data-driven and unsupervised. External knowledge introduces bias and violates the non-medical scope.

---

## 3. Cell State Object Definition (Conceptual)

This is a **conceptual data model**, not code or JSON schema.

### Core Properties

#### state_id
- **Type**: Unique identifier (string or integer)
- **Purpose**: Uniquely identifies a state within a state model version
- **Format**: Versioned (e.g., "v1_state_3" or "state_3_v1")
- **Uniqueness**: Scoped to a state model version

#### Defining Features
- **Type**: Vector or set of embedding dimension indices
- **Purpose**: Identifies which embedding dimensions are most characteristic of this state
- **Not**: Gene names or expression values
- **Representation**: Which dimensions in the latent space define this state's location
- **Example**: "State 3 is defined by high values in embedding dimensions [5, 12, 45, 78]"

#### Stability Score
- **Type**: Float between 0 and 1
- **Purpose**: Measures how consistent this state is across different samples
- **Interpretation**: 
  - High (near 1.0): State is stable, samples cluster tightly
  - Low (near 0.0): State is unstable, high variance
- **Calculation**: Based on variance of samples assigned to this state
- **Not**: A measure of health, normality, or desirability

#### Variance Profile
- **Type**: Vector of variances per embedding dimension
- **Purpose**: Describes how variable this state is across its defining dimensions
- **Use**: Identifies which dimensions contribute most to state instability
- **Not**: A measure of abnormality or deviation from a norm

#### Confidence Interval
- **Type**: Range or distribution parameters
- **Purpose**: Quantifies uncertainty in state assignment
- **Representation**: For each sample, probability of belonging to this state
- **Soft Assignment**: Samples can belong to multiple states with different probabilities
- **Not**: A measure of diagnostic certainty

#### Versioning Rules
- **Type**: Metadata about state model evolution
- **Purpose**: Tracks how state definitions change over time
- **Components**:
  - State model version (e.g., "v1.0", "v2.1")
  - Creation timestamp
  - Parent state model version (if updated)
  - Change log (what changed and why)
- **Compatibility**: States from different versions are not directly comparable

### State Model Structure

A **state model** is a collection of states inferred from a set of embeddings:

- Contains multiple states (typically 3-20 for initial models)
- Each state has the properties above
- States are mutually exclusive in their "core" regions but overlap in boundaries
- State model is versioned as a whole

### Sample-State Assignment

Each sample (cell or bulk sample) has:
- **Primary state**: Highest probability assignment
- **Secondary states**: Other states with significant probability (> threshold)
- **Assignment probabilities**: Vector of probabilities for all states
- **Confidence**: Overall confidence in assignment (based on distance to state centers)

---

## 4. State Inference Rules

### General Approach

States are inferred through **unsupervised clustering** of embeddings. The process:

1. Takes embeddings as input (from Phase 1)
2. Identifies clusters in embedding space
3. Defines states based on cluster properties
4. Assigns samples to states probabilistically
5. Computes state properties (stability, variance, etc.)

### Clustering Method (Conceptual)

The clustering approach:
- Operates in embedding space (not raw expression space)
- Identifies dense regions in the embedding distribution
- Groups samples that are "close" in embedding space
- Does NOT use external labels or annotations

**Note**: Specific algorithms (k-means, Leiden, DBSCAN, etc.) are implementation details to be decided during Phase 2 implementation. This design spec does not prescribe algorithms.

### Soft Assignment

**Soft assignment** means samples can belong to multiple states with varying probabilities:

- **Probability Distribution**: Each sample has a probability vector over all states
- **Sum to One**: Probabilities sum to 1.0 across all states
- **Threshold**: States with probability > threshold (e.g., 0.1) are considered "active"
- **Primary State**: State with highest probability
- **Boundary Samples**: Samples near state boundaries have more uniform probability distribution

**Rationale**: Biological systems are continuous, not discrete. Hard boundaries are artificial.

### Uncertainty Representation

Uncertainty is represented through:

1. **Assignment Probabilities**: How confident is the assignment to each state?
2. **Distance Metrics**: How far is the sample from state centers?
3. **Confidence Intervals**: Statistical bounds on state membership
4. **Variance Profiles**: How much does this state vary?

Uncertainty is:
- **Quantified**: Not just "high" or "low", but numerical
- **Multi-dimensional**: Different for different states
- **Propagated**: Carried through all downstream analysis
- **Visible**: Never hidden or smoothed away

### State Drift

**State drift** refers to:
- Changes in state definitions over time (when new data is added)
- Movement of samples between states (in time-series data, Phase 3)
- Instability in state boundaries
- Evolution of state properties (stability, variance)

State drift is:
- **Expected**: Normal when new data is incorporated
- **Tracked**: Versioning captures drift over time
- **Not**: A sign of error or failure
- **Not**: A medical or biological claim

---

## 5. Explicit Non-Claims

Phase 2 will **never** claim or imply:

### No Disease Meaning
- States do not represent diseases
- States do not indicate pathology
- States do not correlate with medical conditions
- States are mathematical abstractions only

### No Health Meaning
- States do not represent "healthy" or "unhealthy"
- States do not indicate wellness
- States do not measure health status
- States are neutral computational constructs

### No Causal Interpretation
- States do not cause anything
- States do not result from anything
- States are not effects or causes
- States are descriptive, not explanatory

### No Prognosis
- States do not predict outcomes
- States do not forecast future states
- States do not indicate trajectories (that's Phase 3)
- States are snapshots, not predictions

### No Biological Interpretation
- States do not represent biological processes
- States do not map to known cell types (unless explicitly stated as external annotation, which Phase 2 doesn't use)
- States are not validated against biological knowledge
- States are data-driven only

### No Diagnostic Value
- States cannot be used for diagnosis
- States are not diagnostic tools
- States do not replace medical evaluation
- States are research/observability tools only

### No Treatment Guidance
- States do not suggest treatments
- States do not indicate interventions
- States do not guide therapy
- States are analytical tools, not clinical tools

---

## 6. Phase 2 / Phase 3 Boundary

### What Belongs in Phase 2: State Abstraction

Phase 2 focuses on **identifying and describing states**:

1. **State Discovery**
   - Clustering embeddings into states
   - Defining state properties (stability, variance, etc.)
   - Assigning samples to states (soft assignment)

2. **State Description**
   - Characterizing state properties
   - Computing state statistics
   - Defining state boundaries (probabilistic)

3. **State Comparison**
   - Comparing states to each other
   - Measuring distances between states
   - Identifying similar/dissimilar states

4. **State Versioning**
   - Tracking state model versions
   - Documenting state evolution
   - Maintaining state definitions

5. **State Visualization**
   - Visualizing states in embedding space
   - Showing state boundaries
   - Displaying sample assignments

**Key Characteristic**: Phase 2 is **static** - it describes states at a point in time.

### What Belongs in Phase 3: State Transitions

Phase 3 focuses on **modeling how states change over time**:

1. **Transition Probabilities**
   - Probability of moving from state A to state B
   - Transition matrices
   - Conditional probabilities

2. **Temporal Modeling**
   - How states evolve over time
   - Trajectory prediction (probabilistic)
   - Time-series state analysis

3. **Confidence Decay**
   - How confidence decreases over time
   - Uncertainty propagation
   - Prediction intervals

4. **Trajectory Visualization**
   - Showing state transitions over time
   - Visualizing trajectories
   - Displaying transition probabilities

**Key Characteristic**: Phase 3 is **dynamic** - it models state changes.

### Boundary Rules

**Phase 2 does NOT**:
- Model transitions between states
- Predict future states
- Analyze time-series data
- Compute transition probabilities

**Phase 3 does NOT**:
- Discover new states (uses Phase 2 states)
- Re-cluster embeddings (uses Phase 2 assignments)
- Define state properties (uses Phase 2 definitions)

**Clear Separation**:
- Phase 2: "What states exist?" (static)
- Phase 3: "How do states change?" (dynamic)

### Data Flow

```
Phase 1 Outputs (embeddings)
    ↓
Phase 2: State Abstraction
    ↓
State Definitions + Sample Assignments
    ↓
Phase 3: State Transitions (if temporal data available)
```

Phase 3 requires:
- Phase 2 state definitions
- Temporal data (samples with timestamps or time-series)
- State assignments from Phase 2

---

## Implementation Notes (For Future Reference)

This section is for future implementers, not current work.

### Design Principles
- Unsupervised only (no labels)
- Probabilistic (soft assignment)
- Versioned (track changes)
- Reproducible (deterministic)
- Neutral (no medical claims)

### Key Constraints
- Must consume only Phase 1 outputs
- Must not use external annotations
- Must not make medical claims
- Must be deterministic
- Must be versioned

### Success Criteria (Future)
- States are discovered from embeddings
- States are stable across similar datasets
- State assignments are reproducible
- State properties are well-defined
- No medical terminology in outputs

---

**End of Phase 2 Design Specification**

This document defines Phase 2 conceptually. Implementation will follow in a future phase, respecting PHASE1_FREEZE.md and this design specification.
